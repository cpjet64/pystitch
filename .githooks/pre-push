#!/usr/bin/env bash
set -euo pipefail

repo_root="$(git rev-parse --show-toplevel)"
cd "$repo_root"

select_python() {
  local candidates=(
    ".venv/3.13/Scripts/python.exe"
    ".venv/3.13/bin/python"
  )
  local candidate
  for candidate in "${candidates[@]}"; do
    if [[ -x "$candidate" ]]; then
      echo "$candidate"
      return 0
    fi
  done
  if command -v python >/dev/null 2>&1; then
    echo "python"
    return 0
  fi
  return 1
}

if ! PYTHON="$(select_python)"; then
  echo "[pre-push] Could not find a Python interpreter. Create a project venv first."
  exit 1
fi

echo "[pre-push] Running strict supported-version, packaging, and audit checks..."
"$PYTHON" -m nox -s ci package-3.13 audit-3.13

echo "[pre-push] Strict push checks passed."
